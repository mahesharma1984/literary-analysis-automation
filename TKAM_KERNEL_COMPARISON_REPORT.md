# TKAM Kernel and Stage Files Compatibility Report

## Summary

The TKAM kernel (`To_Kill_a_Mockingbird_kernel_v3_4.json`) is **partially compatible** with the latest `create_kernel.py` and stage automation files, but is missing several fields that would be generated by the current version.

## Current Status

### ✅ What's Present (Compatible)

1. **Metadata Structure** ✓
   - Has `metadata` with `title`, `author`, `edition`, `protocol_version`, `kernel_version`, `chapter_aware`
   - Version is correctly set to `3.4`

2. **Narrative Position Mapping** ✓
   - Has `narrative_position_mapping` with:
     - `chapter_range` for each section
     - `primary_chapter` for each section
     - `pages` (bonus field)

3. **Text Structure** ✓
   - Has `text_structure` with:
     - `has_chapters: true`
     - `total_chapters_estimate: 31`
     - `notes`

4. **Macro Variables** ✓
   - Has complete `macro_variables` structure with:
     - `narrative.voice` (all fields)
     - `narrative.structure` (all fields)
     - `rhetoric` (all fields)
     - `device_mediation`

5. **Extracts** ✓ (partial)
   - Has `extracts` with all 5 Freytag sections
   - Each section has `text`, `rationale`, `word_count`

### ❌ What's Missing (Incompatibilities)

1. **Missing `chapter_range` and `primary_chapter` in `extracts` sections**
   - **Current**: Extracts only have `text`, `rationale`, `word_count`
   - **Expected**: Each extract should also have:
     ```json
     "exposition": {
       "text": "...",
       "rationale": "...",
       "word_count": 645,
       "chapter_range": "1-3",      // MISSING
       "primary_chapter": 1          // MISSING
     }
     ```
   - **Impact**: `run_stage1a.py` expects `extracts.get("exposition", {}).get("chapter_range", "")` which will return empty string
   - **Workaround**: Stage file can fall back to `narrative_position_mapping`, but this is not implemented

2. **Missing `assigned_section` in `micro_devices`**
   - **Current**: Devices only have `name`, `definition`, `examples`
   - **Expected**: Each device should have:
     ```json
     {
       "name": "Metaphor",
       "assigned_section": "exposition",  // MISSING
       "layer": "B",                       // MISSING
       "function": "Me",                   // MISSING
       "engagement": "V",                  // MISSING
       "classification": "Layer|Function|Engagement",  // MISSING
       "position_code": "DIST",            // MISSING
       ...
     }
     ```
   - **Impact**: `run_stage1a.py` will fall back to chapter-based matching (METHOD 2), which is less precise
   - **Workaround**: Stage file has fallback logic, so it will still work

3. **Missing Device Taxonomy Fields**
   - Missing: `layer`, `function`, `engagement`, `classification`, `position_code`
   - Missing: `student_facing_type`, `pedagogical_function`
   - **Impact**: Stage files expect these fields for proper categorization and may use empty strings as fallback

4. **Example Structure Differences**
   - **Current**: Examples have `text`, `explanation`, `location`, `narrative_position`, `chapter`, `page`, `chapter_range`
   - **Expected** (from latest create_kernel.py): Examples should have:
     ```json
     {
       "freytag_section": "exposition",
       "scene": "brief scene identifier",
       "chapter": 1,
       "page_range": "X-Y",
       "quote_snippet": "20-100 character exact quote"
     }
     ```
   - **Impact**: Different field names may cause issues in downstream processing

## Compatibility Assessment

### Stage 1A (`run_stage1a.py`)
- **Status**: ⚠️ **Will work with fallbacks, but not optimal**
- **Issues**:
  - `get_narrative_chapter_ranges()` will return empty lists because `extracts` sections don't have `chapter_range`
  - Device assignment will use METHOD 2 (chapter-based matching) instead of METHOD 1 (`assigned_section`)
  - Missing device taxonomy fields will result in empty strings

### Stage 1B (`run_stage1b.py`)
- **Status**: ✅ **Should work** (depends on Stage 1A output)
- **Issues**: None directly, but inherits any issues from Stage 1A

### Stage 2 (`run_stage2.py`)
- **Status**: ✅ **Should work** (depends on Stage 1B output)
- **Issues**: None directly

## Recommendations

### Option 1: Update TKAM Kernel to Match Latest Format (Recommended)

Run the kernel through the latest `create_kernel.py` to regenerate it with all required fields:

```bash
python create_kernel.py \
  books/TKAM.pdf \
  "To Kill a Mockingbird" \
  "Harper Lee" \
  "Harper Perennial Modern Classics, 2006" \
  31
```

**Pros**:
- Full compatibility with all stage files
- Uses optimal assignment method (`assigned_section`)
- Includes all taxonomy fields for proper categorization
- Matches latest protocol standards

**Cons**:
- Requires re-running kernel creation (API costs)
- May produce slightly different device assignments

### Option 2: Patch Current Kernel (Quick Fix)

Add missing fields to existing kernel:

1. **Add `chapter_range` and `primary_chapter` to extracts**:
   - Copy from `narrative_position_mapping` to each `extracts` section

2. **Add `assigned_section` to devices**:
   - Infer from device examples' `narrative_position` or `chapter_range` fields

3. **Add device taxonomy fields**:
   - Would require manual classification or running device analysis

**Pros**:
- Preserves existing kernel content
- No API costs
- Quick fix

**Cons**:
- Manual work required
- May not be as accurate as regenerated kernel
- Missing some taxonomy classifications

### Option 3: Update Stage Files to Handle Current Format (Not Recommended)

Modify `run_stage1a.py` to:
- Use `narrative_position_mapping` as fallback for `chapter_range` in extracts
- Better handle missing device taxonomy fields

**Pros**:
- No changes to kernel needed

**Cons**:
- Stage files become more complex
- Doesn't address root cause
- Other kernels may have same issues

## Detailed Field Comparison

### Extracts Structure

| Field | Current TKAM | Latest create_kernel.py | Status |
|-------|-------------|------------------------|--------|
| `text` | ✅ | ✅ | OK |
| `rationale` | ✅ | ✅ | OK |
| `word_count` | ✅ | ❌ | Extra (not required) |
| `chapter_range` | ❌ | ✅ | **MISSING** |
| `primary_chapter` | ❌ | ✅ | **MISSING** |

### Micro Devices Structure

| Field | Current TKAM | Latest create_kernel.py | Status |
|-------|-------------|------------------------|--------|
| `name` | ✅ | ✅ | OK |
| `definition` | ✅ | ✅ | OK |
| `examples` | ✅ | ✅ | OK |
| `assigned_section` | ❌ | ✅ | **MISSING** |
| `layer` | ❌ | ✅ | **MISSING** |
| `function` | ❌ | ✅ | **MISSING** |
| `engagement` | ❌ | ✅ | **MISSING** |
| `classification` | ❌ | ✅ | **MISSING** |
| `position_code` | ❌ | ✅ | **MISSING** |
| `student_facing_type` | ❌ | ✅ | **MISSING** |
| `pedagogical_function` | ❌ | ✅ | **MISSING** |

## Conclusion

The TKAM kernel is **functionally compatible** with the stage files due to fallback logic, but is **not fully compliant** with the latest `create_kernel.py` output format. For optimal results and full compatibility, it should be regenerated using the latest version of `create_kernel.py`.



